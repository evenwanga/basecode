æˆ‘å·²ç»ä»”ç»†åˆ†æäº†ä½ æä¾›çš„ `info.md` æ–‡æ¡£ï¼Œå¹¶ç»“åˆä½ åˆšæ‰æå‡ºçš„ **5 ç‚¹æ ¸å¿ƒçº¦æŸ**ï¼ˆJDK 17ã€Mavenã€PgSQLã€Redisã€Spring Boot 4ï¼‰ï¼Œä¸ºä½ åˆ¶å®šäº†ä»¥ä¸‹å¯è½åœ°çš„å¼€å‘è®¡åˆ’ã€‚

---

### æœ€æ–°æ‰§è¡Œè¿›å±•ï¼ˆæˆªè‡³å½“å‰ï¼‰

- åŸºç¡€è®¾æ–½ï¼šå¤šç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸å¼‚å¸¸é“¾ç¨³å®šï¼ŒRedis/PG é…ç½®ä¸æ–‡æ¡£åŒæ­¥ï¼›å…¨é‡æ„å»ºå¯åœ¨æœ¬æœºé€šè¿‡ã€‚
- è®¤è¯æˆæƒï¼šSpring Authorization Server æ¥å…¥å®Œæˆï¼Œ`DomainUserDetailsService` æŒ‰ identity.userId åŠ è½½ç”¨æˆ·ï¼›é»˜è®¤å®¢æˆ·ç«¯åˆå§‹åŒ–ï¼›JWK å·²æŒä¹…åŒ–åˆ°å¯é…ç½®æ–‡ä»¶ã€‚
- åº”ç”¨æ¥å£ï¼šå®¢æˆ·ç«¯æ³¨å†Œä¸å†å›ä¼ æ˜æ–‡ secretï¼›ç§Ÿæˆ·åˆ‡æ¢æ ¡éªŒæˆå‘˜å…³ç³»ï¼›æ³¨å†Œæ¥å£å¢åŠ é‚®ç®±/æ‰‹æœºå·æŸ¥é‡ï¼Œé¿å…å‘½ä¸­å”¯ä¸€çº¦æŸç›´æ¥è¿”å› 500ï¼›Access ç»‘å®šè¯·æ±‚è¡¥é½ @NotNullï¼›Tenant code æŸ¥é‡ã€‚
- è´¨é‡ä¿éšœï¼šèº«ä»½/ç§Ÿæˆ·æ§åˆ¶å™¨å•æµ‹ã€æˆæƒåŸŸå•æµ‹åŠ Testcontainers é›†æˆæµ‹è¯•åœ¨ Docker ç¯å¢ƒä¸‹é€šè¿‡ï¼ˆéœ€é…ç½® `DOCKER_HOST=unix:///Users/wangyiwen/.docker/run/docker.sock`ï¼‰ï¼›éªŒè¯ç é€»è¾‘æ”¹ä¸ºéšæœºç å¹¶å¯é…ç½®å›ºå®šå€¼ç”¨äºæµ‹è¯•ã€‚
- è¿è¡Œæ–¹å¼ï¼šå·²å®Œæˆæœ¬åœ° Docker åŒ–è¿è¡Œï¼Œ`docker-compose` æä¾› postgres(5543)ã€redis(6380)ã€app(8081â†’8080)ï¼›`uc-start` é»˜è®¤äº§å‡ºå¯æ‰§è¡Œ Boot Jarã€‚
- å¾…å¤„ç†ï¼šç»§ç»­æ‰©å±•æµ‹è¯•è¦†ç›–ä¸ AI/MCP é…ç½®ï¼›é˜¶æ®µä»»åŠ¡æŒ‰è·¯çº¿æ¨è¿›ã€‚

> ğŸ“Œ **é¢†åŸŸå¢å¼ºè®¡åˆ’**ï¼šè¯¦è§ [plan-domain-enhancement.md](./plan-domain-enhancement.md)ï¼ŒåŒ…å«å¹³å°ç§Ÿæˆ·æ”¯æŒã€ç»„ç»‡æ¶æ„ CRUD ç­‰åŠŸèƒ½ã€‚
> 
> ğŸ¯ **TDD æ‰§è¡ŒæŒ‡å—**ï¼šè¯¦è§ [TDD-TASK-CARDS.md](./TDD-TASK-CARDS.md)ï¼ŒæŒ‰å¡ç‰‡é¡ºåºæ‰§è¡Œå³å¯å®Œæˆå¼€å‘ã€‚

### é˜¶æ®µè¿›åº¦å¯¹ç…§

- **ç¬¬ä¸€é˜¶æ®µï¼ˆè„šæ‰‹æ¶ä¸åŸºç¡€è®¾æ–½åˆå§‹åŒ–ï¼‰**ï¼šâœ… å·²å®Œæˆã€‚
- **ç¬¬äºŒé˜¶æ®µï¼ˆæ ¸å¿ƒé¢†åŸŸæ¨¡å‹å®ç°ï¼‰**ï¼šâœ… å·²å®Œæˆã€‚
- **ç¬¬ä¸‰é˜¶æ®µï¼ˆè®¤è¯ä¸æˆæƒæœåŠ¡ï¼‰**ï¼šâœ… å·²å®Œæˆï¼ˆJWK å·²æŒä¹…åŒ–ï¼‰ã€‚
- **ç¬¬å››é˜¶æ®µï¼ˆå¯¹å¤–æ¥å£ä¸åº”ç”¨å±‚ï¼‰**ï¼šâœ… å·²å®Œæˆå®¢æˆ·ç«¯ç®¡ç†ã€ç”¨æˆ·ä¿¡æ¯ã€ç§Ÿæˆ·åˆ‡æ¢æ¥å£åŠæ ¡éªŒã€‚
- **ç¬¬äº”é˜¶æ®µï¼ˆTDD/AI é›†æˆï¼‰**ï¼šğŸ”„ è¿›è¡Œä¸­ï¼Œå•æµ‹ä¸é›†æˆæµ‹è¦†ç›–æ ¸å¿ƒåŸŸï¼ŒMCP é…ç½®å¾…è¿›ä¸€æ­¥å®Œå–„ã€‚
- **ç¬¬å…­é˜¶æ®µï¼ˆé¢†åŸŸå¢å¼ºï¼šå¹³å°ç§Ÿæˆ·ä¸ç»„ç»‡æ¶æ„ï¼‰**ï¼šâ³ å¾…å¼€å§‹ï¼Œè¯¦è§ [plan-domain-enhancement.md](./plan-domain-enhancement.md)ã€‚
  - 6.1 Tenant ç±»å‹æ”¯æŒ [P0]
  - 6.2 å¹³å°ç§Ÿæˆ·æœåŠ¡ [P0]
  - 6.3 ç»„ç»‡ç®¡ç† API [P1]
  - 6.4 MembershipRepository æ‰©å±• [P1]
  - 6.5 æµ‹è¯•å®Œå–„ [P1]

-----

### 1\. é¡¹ç›®æ ¸å¿ƒæŠ€æœ¯æ ˆä¸çº¦æŸç¡®è®¤

æˆ‘ä»¬å°†ä¸¥æ ¼éµå¾ªä»¥ä¸‹åŸºçº¿è¿›è¡Œå·¥ç¨‹æ­å»ºï¼š

  * **å¼€å‘è¯­è¨€**ï¼šJava 17 (LTS) â€”â€” *æ”¾å¼ƒ Java 21 çš„è™šæ‹Ÿçº¿ç¨‹ï¼Œä½¿ç”¨æ ‡å‡†çš„çº¿ç¨‹æ¨¡å‹ã€‚*
  * **æ ¸å¿ƒæ¡†æ¶**ï¼šSpring Boot 4.0.0 (åŸºäº Spring Framework 7 & Jakarta EE 11) â€”â€” *æ³¨ï¼šæˆ‘ä»¬å°†é‡ç‚¹ä½¿ç”¨æ–‡æ¡£ä¸­æåˆ°çš„ `@HttpExchange`ã€Observability ç­‰æ–°ç‰¹æ€§ã€‚*
  * **æ„å»ºå·¥å…·**ï¼šMaven 3.9+ â€”â€” *ä½¿ç”¨ Multi-module ç»“æ„ç®¡ç†ä¾èµ–ã€‚*
  * **æ•°æ®åº“**ï¼šPostgreSQL 15+ â€”â€” *ä½œä¸ºä¸»å­˜å‚¨ã€‚*
  * **ç¼“å­˜/ä¼šè¯**ï¼šRedis 7+ï¼ˆæœ¬æœº Docker é…ç½®å†™åœ¨ `.env.example`ï¼‰ï¼Œç”¨äºéªŒè¯ç ã€çŸ­æœŸ stateã€ä¼šè¯é»‘åå•/ç¼“å­˜ï¼›æŒä¹…åŒ–æ•°æ®ä»è½åœ° PostgreSQLã€‚
  * **æ¶æ„é£æ ¼**ï¼šæ¨¡å—åŒ–å•ä½“ (Modular Monolith) + DDD (é¢†åŸŸé©±åŠ¨è®¾è®¡)ã€‚

-----

### 2\. å·¥ç¨‹æ¶æ„è®¾è®¡ (Maven å¤šæ¨¡å—)

æˆ‘ä»¬å°†é¡¹ç›®æ‹†åˆ†ä¸º **åŸºç¡€è„šæ‰‹æ¶ (`company-platform`)** å’Œ **ä¸šåŠ¡åº”ç”¨ (`user-center`)** ä¸¤å¤§éƒ¨åˆ†ï¼Œå…¨éƒ¨åœ¨ä¸€ä¸ª Maven Reactor ä¸­ç®¡ç†ï¼ˆæˆ–åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹ Repoï¼Œå»ºè®®åˆæœŸåœ¨ä¸€ä¸ª Repo ä¸­ä»¥ä¾¿è°ƒè¯•ï¼‰ã€‚

**ç›®å½•ç»“æ„é¢„è§ˆï¼š**

```text
user-center-monolith/
â”œâ”€â”€ pom.xml (Root POM: å®šä¹‰ Spring Boot 4 Parent, Java 17, å…¨å±€ç‰ˆæœ¬)
â”œâ”€â”€ company-platform/                 # [è„šæ‰‹æ¶] é€šç”¨èƒ½åŠ›æ²‰æ·€
â”‚   â”œâ”€â”€ pom.xml
â”‚   â”œâ”€â”€ platform-dependencies/        # BOM (ç»Ÿä¸€ç®¡ç†ä¾èµ–ç‰ˆæœ¬)
â”‚   â”œâ”€â”€ platform-common/              # å·¥å…·ç±», å¼‚å¸¸å®šä¹‰, Resultå°è£…
â”‚   â”œâ”€â”€ platform-web/                 # å…¨å±€å¼‚å¸¸å¤„ç†, Jacksoné…ç½®, WebMvcé…ç½®
â”‚   â”œâ”€â”€ platform-jpa/                 # JPAé…ç½®, å¤šç§Ÿæˆ·æ‹¦æˆªå™¨, å®¡è®¡å­—æ®µ
â”‚   â”œâ”€â”€ platform-security/            # SecurityåŸºç¡€é“¾, å¯†ç åŠ å¯†, JWTå·¥å…·
â”‚   â”œâ”€â”€ platform-ai/                  # MCPé›†æˆä¸AIå·¥å…·
â”‚   â””â”€â”€ platform-test/                # å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•åŸºç±» (Testcontainers)
â”œâ”€â”€ user-center/                      # [ä¸šåŠ¡åŸŸ] æ¨¡å—åŒ–å•ä½“
â”‚   â”œâ”€â”€ pom.xml
â”‚   â”œâ”€â”€ uc-api/                       # å¯¹å¤–æš´éœ²çš„ DTO å’Œ Feign/HttpExchange æ¥å£
â”‚   â”œâ”€â”€ uc-domain-tenant/             # ç§Ÿæˆ· & ç»„ç»‡åŸŸ (Domain + Infrastructure)
â”‚   â”œâ”€â”€ uc-domain-identity/           # ç”¨æˆ· & èº«ä»½åŸŸ (User, Identity, Membership)
â”‚   â”œâ”€â”€ uc-domain-access/             # æƒé™åŸŸ (RBAC, Role, Permission)
â”‚   â”œâ”€â”€ uc-domain-auth/               # è®¤è¯åŸŸ (OAuth2 Server, Sessionç®¡ç† - çº¯DBå®ç°)
â”‚   â””â”€â”€ uc-start/                     # å¯åŠ¨æ¨¡å— (Application, API Controller, é…ç½®èšåˆ)
```

-----

### 3\. è¯¦ç»†å®æ–½è·¯çº¿å›¾ (Roadmap)

æˆ‘ä»¬å°†åˆ† 5 ä¸ªé˜¶æ®µå®Œæˆå¼€å‘ã€‚

#### ç¬¬ä¸€é˜¶æ®µï¼šè„šæ‰‹æ¶ä¸åŸºç¡€è®¾æ–½åˆå§‹åŒ– (Platform Foundation)

**ç›®æ ‡**ï¼šæ­å»º Maven éª¨æ¶ï¼Œç»Ÿä¸€è§„èŒƒï¼Œæ‰“é€šæ•°æ®åº“è¿æ¥ã€‚

1.  **Mavené…ç½®**ï¼š
      * åˆ›å»ºçˆ¶å·¥ç¨‹ `pom.xml`ï¼Œé”å®š JDK 17ï¼Œå¼•å…¥ `spring-boot-starter-parent` (4.0.0)ã€‚
      * é…ç½® Checkstyle å’Œ Spotbugs æ’ä»¶ã€‚
2.  **Platform Core**ï¼š
      * `platform-common`ï¼šå®šä¹‰ `BaseEntity` (id, created\_at, updated\_at)ï¼Œ`Result<T>` ç»Ÿä¸€å“åº”ä½“ã€‚
      * `platform-jpa`ï¼šé›†æˆ `spring-boot-starter-data-jpa` + `postgresql`ã€‚
      * **å…³é”®ç‚¹**ï¼šå®ç°å¤šç§Ÿæˆ·éš”ç¦»ï¼ˆTenantContext + SQL è¿‡æ»¤ï¼‰ï¼ŒRedis ä»…ä½œç¼“å­˜/çŠ¶æ€ï¼Œä¸æ‰¿è½½ä¸»æ•°æ®ã€‚
3.  **Platform Web**ï¼š
      * å®ç° `GlobalExceptionHandler`ã€‚
      * é…ç½® Swagger/OpenAPI (SpringDoc)ã€‚

#### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒé¢†åŸŸæ¨¡å‹å®ç° (Domain Implementation)

**ç›®æ ‡**ï¼šå®Œæˆ Tenant, Organization, Identity ä¸‰å¤§æ ¸å¿ƒåŸŸçš„ CRUDã€‚

1.  **Tenant åŸŸ** (`uc-domain-tenant`)ï¼š
      * å®ä½“ï¼š`Tenant`, `OrganizationUnit`ã€‚
      * åŠŸèƒ½ï¼šç§Ÿæˆ·åˆ›å»ºã€ç»„ç»‡æ ‘ç®¡ç†ã€‚
2.  **Identity åŸŸ** (`uc-domain-identity`)ï¼š
      * å®ä½“ï¼š`User`, `UserIdentity` (è´¦å·/æ‰‹æœº/é‚®ç®±), `Membership` (å…³è” Tenant)ã€‚
      * **Redis ç­–ç•¥**ï¼šéªŒè¯ç ï¼ˆOTPï¼‰å­˜ Redisï¼ˆé”®åŒ…å« receiver+typeï¼ŒTTL æ§åˆ¶ï¼‰ï¼ŒåŒæ—¶å¯é€‰è½åº“å®¡è®¡ï¼›è·å–éªŒè¯ç å‰æ¸…ç†æ—§é”®ã€‚
3.  **Access åŸŸ** (`uc-domain-access`)ï¼š
      * å®ä½“ï¼š`Role`, `Permission`ã€‚
      * åŠŸèƒ½ï¼šç®€å•çš„ RBAC æˆæƒé€»è¾‘ã€‚

#### ç¬¬ä¸‰é˜¶æ®µï¼šè®¤è¯ä¸æˆæƒæœåŠ¡ (Auth & Security)

**ç›®æ ‡**ï¼šå®ç° OIDC/OAuth2.1 èƒ½åŠ›ï¼Œæ›¿ä»£ Redis è¿›è¡Œä¼šè¯ç®¡ç†ã€‚å½“å‰è¿›åº¦ï¼šå·²å®ç°ï¼Œå¾…è¡¥ JWK æŒä¹…åŒ–ã€‚

1.  **Spring Authorization Server é›†æˆ**ï¼š
      * åœ¨ `uc-domain-auth` ä¸­å¼•å…¥ `spring-boot-starter-oauth2-authorization-server`ã€‚
      * **é…ç½®**ï¼šJDBC RegisteredClient/Authorization/Consent æœåŠ¡ï¼ŒJWK ç”Ÿæˆã€JWT è§£ç ï¼ŒåŒå®‰å…¨é“¾ï¼ˆæˆæƒç«¯ç‚¹ + åº”ç”¨æ¥å£ï¼‰ã€‚
      * **çŠ¶æ€**ï¼šå·²å®Œæˆï¼ŒJWK ç›®å‰å†…å­˜ç”Ÿæˆï¼Œé‡å¯ä¼šä½¿æ—§ä»¤ç‰Œå¤±æ•ˆï¼ˆå¾…æŒä¹…åŒ–ï¼‰ã€‚
      * Schema åˆå§‹åŒ–ï¼šæ–°å¢è¿ç§» `V4__oauth2_authorization_server.sql` åˆ›å»º `oauth2_*` è¡¨ã€‚
2.  **ç™»å½•æµç¨‹**ï¼š
      * å®ç° `DomainUserDetailsService` å¯¹æ¥ Identity åŸŸæœ¬åœ°å¯†ç èº«ä»½ã€‚
      * æ”¯æŒ `authorization_code`ã€`client_credentials`ã€`refresh_token`ã€‚
      * é»˜è®¤å®¢æˆ·ç«¯ï¼šå¯åŠ¨æ—¶åˆå§‹åŒ– `user-center-web`ï¼ˆè§ `DefaultOAuth2ClientInitializer`ï¼‰ã€‚

#### ç¬¬å››é˜¶æ®µï¼šå¯¹å¤–æ¥å£ä¸åº”ç”¨å±‚ (Application Layer)

**ç›®æ ‡**ï¼šæš´éœ² REST APIï¼Œå®Œæˆ Application ç®¡ç†ã€‚

1.  **Client Application ç®¡ç†**ï¼š
      * ä»¿ç…§ Logtoï¼Œæä¾› API ç®¡ç† `ClientApplication` (clientId, secret, redirectUris)ã€‚
      * å°†æ³¨å†Œçš„ Client åŒæ­¥å†™å…¥ `oauth2_registered_client` è¡¨ã€‚
2.  **User Center API**ï¼š
      * `/api/v1/users/me` (è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯)ã€‚
      * `/api/v1/tenants` (åˆ‡æ¢ç§Ÿæˆ·)ã€‚
3.  **Http Interfaces**ï¼š
      * ä½¿ç”¨ Spring Boot 4 çš„ `@HttpExchange` å®šä¹‰æ¨¡å—é—´ï¼ˆå¦‚æœæœªæ¥æ‹†å¾®æœåŠ¡ï¼‰æˆ–å¯¹å¤–çš„å£°æ˜å¼å®¢æˆ·ç«¯ã€‚

#### ç¬¬äº”é˜¶æ®µï¼šTDD æµç¨‹ä¸ AI é›†æˆ

**ç›®æ ‡**ï¼šå»ºç«‹è´¨é‡ä¿éšœä½“ç³»ã€‚

1.  **æµ‹è¯•ç­–ç•¥**ï¼š
      * ä½¿ç”¨ JUnit 5 + Mockitoã€‚
      * ä½¿ç”¨ **Testcontainers (PostgreSQL)** è¿›è¡Œ Repository å’Œ Controller çš„é›†æˆæµ‹è¯•ï¼ˆæ›¿ä»£ H2ï¼Œç¡®ä¿ä¸ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“è¡Œä¸ºä¸€è‡´ï¼‰ã€‚
2.  **AI/MCP é›†æˆ**ï¼š
      * æŒ‰ç…§æ–‡æ¡£è¦æ±‚ï¼Œåˆ›å»º `AGENTS.md` å’Œ `docs/spec/*.md`ã€‚
      * ç¼–å†™ MCP Server å·¥å…·ç±»ï¼ˆå¯é€‰ï¼‰ï¼Œç”¨äºè®© AI è¯»å–é¡¹ç›®ç»“æ„ã€‚

-----

### 4\. å…³é”®æŠ€æœ¯ç‚¹è§£ç­” (Q\&A)

**Q: Redis çš„ä½œç”¨ä¸æœ¬åœ°é…ç½®ï¼Ÿ**

  * **A**: Redis ç”¨äºéªŒè¯ç ã€çŸ­æœŸ state/nonceã€ä¼šè¯é»‘åå•åŠçƒ­ç‚¹æŸ¥è¯¢ç¼“å­˜ï¼›ä¸»æ•°æ®ï¼ˆç”¨æˆ·ã€ç§Ÿæˆ·ã€ä»¤ç‰ŒæŒä¹…åŒ–ï¼‰ä»åœ¨ PostgreSQL ä¸­ã€‚`.env.example` å·²æä¾›æœ¬æœº Redis é…ç½®ï¼ˆé»˜è®¤ç«¯å£ 6379ï¼Œå¯é€šè¿‡ Docker å¯åŠ¨ï¼‰ï¼Œå¼€å‘/æµ‹è¯•æŒ‰éœ€å¯åœã€‚
  * **ä¼˜åŒ–ç­–ç•¥**ï¼šå¯¹çƒ­ç‚¹è¯»ï¼ˆTenantã€Role å®šä¹‰ç­‰ï¼‰å¯å¼•å…¥ Spring Cacheï¼ˆRedis backed æˆ– Caffeine è¿›ç¨‹å†…ï¼‰å¹¶è®¾ç½®åˆç† TTLï¼›ä»éœ€ä¿è¯æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–ã€‚

**Q: Spring Boot 4 çš„å…¼å®¹æ€§ï¼Ÿ**

  * **A**: è™½ç„¶ Spring Boot 4 æ˜¯å‰æ²¿ç‰ˆæœ¬ï¼Œä½†æˆ‘ä»¬å°†ä¸»è¦ä¾èµ– Spring Framework 6.1+/7 çš„æ ‡å‡† APIã€‚å¦‚æœ 4.0.0 çš„æŸäº› Starter å°šæœªå‘å¸ƒï¼Œæˆ‘ä»¬å°†å›é€€åˆ° Spring Boot 3.2+ (å®ƒæ˜¯ 4.0 çš„åŸºç¡€)ï¼Œä½†ä»£ç é£æ ¼ï¼ˆå¦‚ Records, HTTP Interfacesï¼‰ä¿æŒæœ€æ–°ï¼Œç¡®ä¿æ— ç¼å‡çº§ã€‚

-----
